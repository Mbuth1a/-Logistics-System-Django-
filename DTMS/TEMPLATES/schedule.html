<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Vehicle Schedules</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            color: #333;
        }

        .sidebar {
            background-color: #343a40;
            color: #fff;
           
        }

        .sidebar button {
            color: #3ff4ff;
        }

        .card {
            background-color: #fff;
            border-color: #ff7f50;
        }

        .card .card-title {
            color: #ff7f50;
        }

        .btn-warning {
            background-color: #ff7f50;
            border-color: #ff7f50;
        }

        .btn-info, .btn-danger {
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-2 d-none d-md-block sidebar">
                <div class="sidebar-sticky">
                    <button onclick="window.history.back()" class="btn btn-light btn-block">Back</button>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-10">
                <div class="row">
                    <!-- Vehicles List -->
                    <div class="col-md-12">
                        <h3>Vehicles</h3>
                        <div id="vehiclesList" class="row">
                            {% for vehicle in vehicles %}
                                <div class="col-md-4 vehicle-card" data-vehicle-id="{{ vehicle.id }}">
                                    <div class="card mb-4 shadow-sm">
                                        <div class="card-body">
                                            <h5 class="card-title">{{ vehicle.vehicle_regno }}</h5>
                                            <button class="btn btn-warning" data-toggle="modal" data-target="#createScheduleModal" data-vehicle="{{ vehicle.id }}">Create Schedule</button>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Schedules Section -->
                    <div class="col-md-12 mt-4">
                        <h3>Schedules</h3>
                        <div id="schedulesSection" class="row">
                            {% for schedule in schedules %}
                                <div class="col-md-4">
                                    <div class="card mb-4 shadow-sm" data-schedule-id="{{ schedule.id }}">
                                        <div class="card-body">
                                            <h5 class="card-title">{{ schedule.Vehicle.vehicle_regno }}</h5>
                                            <p>Maintenance: {{ schedule.maintenance_date }}</p>
                                            <p>Inspection: {{ schedule.inspection_date }}</p>
                                            <p>Insurance: {{ schedule.insurance_date }}</p>
                                            <p>Speed Governor: {{ schedule.speed_governor_date }}</p>
                                            <p>Kenha Permit: {{ schedule.kenha_permit_date }}</p>
                                            <button class="btn btn-info editScheduleBtn" data-toggle="modal" data-target="#editScheduleModal" data-id="{{ schedule.id }}">Edit</button>
                                            <button class="btn btn-danger deleteScheduleBtn" data-id="{{ schedule.id }}">Delete</button>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Create Schedule Modal -->
    <div class="modal fade" id="createScheduleModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <form id="createScheduleForm">
                    <div class="modal-header">
                        <h5 class="modal-title">Create Schedule</h5>
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                    </div>
                    <div class="modal-body">
                        {% csrf_token %}
                        <input type="hidden" name="Vehicle" id="vehicleId">
                        <div class="form-group">
                            <label for="serviceProvider">Service Provider</label>
                            <input type="text" name="service_provider" class="form-control" id="serviceProvider" required>
                        </div>
                        <div class="form-group">
                            <label for="maintenanceDate">Maintenance Date</label>
                            <input type="date" name="maintenance_date" class="form-control" id="maintenanceDate" required>
                        </div>
                        <div class="form-group">
                            <label for="inspectionDate">Inspection Date</label>
                            <input type="date" name="inspection_date" class="form-control" id="inspectionDate" required>
                        </div>
                        <div class="form-group">
                            <label for="insuranceDate">Insurance Date</label>
                            <input type="date" name="insurance_date" class="form-control" id="insuranceDate" required>
                        </div>
                        <div class="form-group">
                            <label for="speedGovernorDate">Speed Governor Date</label>
                            <input type="date" name="speed_governor_date" class="form-control" id="speedGovernorDate" required>
                        </div>
                        <div class="form-group">
                            <label for="kenhaPermitDate">Kenha Permit Date</label>
                            <input type="date" name="kenha_permit_date" class="form-control" id="kenhaPermitDate" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Schedule Modal -->
    <div class="modal fade" id="editScheduleModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <form id="editScheduleForm">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Schedule</h5>
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                    </div>
                    <div class="modal-body">
                        {% csrf_token %}
                        <input type="hidden" name="Schedule" id="editScheduleId">
                        <div class="form-group">
                            <label for="editServiceProvider">Service Provider</label>
                            <input type="text" name="service_provider" class="form-control" id="editServiceProvider" required>
                        </div>
                        <div class="form-group">
                            <label for="editMaintenanceDate">Maintenance Date</label>
                            <input type="date" name="maintenance_date" class="form-control" id="editMaintenanceDate" required>
                        </div>
                        <div class="form-group">
                            <label for="editInspectionDate">Inspection Date</label>
                            <input type="date" name="inspection_date" class="form-control" id="editInspectionDate" required>
                        </div>
                        <div class="form-group">
                            <label for="editInsuranceDate">Insurance Date</label>
                            <input type="date" name="insurance_date" class="form-control" id="editInsuranceDate" required>
                        </div>
                        <div class="form-group">
                            <label for="editSpeedGovernorDate">Speed Governor Date</label>
                            <input type="date" name="speed_governor_date" class="form-control" id="editSpeedGovernorDate" required>
                        </div>
                        <div class="form-group">
                            <label for="editKenhaPermitDate">Kenha Permit Date</label>
                            <input type="date" name="kenha_permit_date" class="form-control" id="editKenhaPermitDate" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmationModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this schedule?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function() {
            // Prepopulate vehicle ID in the create schedule modal
            $('#createScheduleModal').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget);
                var vehicleId = button.data('vehicle');
                var modal = $(this);
                modal.find('#vehicleId').val(vehicleId);
            });

            // Create schedule form submit
            $('#createScheduleForm').submit(function(e) {
                e.preventDefault();
                var vehicleId = $('#vehicleId').val();
                $.ajax({
                    type: 'POST',
                    url: '{% url "create_schedule" %}',
                    data: $(this).serialize(),
                    success: function(response) {
                        if (response.success) {
                            var newScheduleCard = `
                            <div class="col-md-4">
                                <div class="card mb-4 shadow-sm" data-schedule-id="${response.schedule.id}">
                                    <div class="card-body">
                                        <h5 class="card-title">${response.schedule.vehicle_regno}</h5>
                                        <p>Maintenance: ${response.schedule.maintenance_date}</p>
                                        <p>Inspection: ${response.schedule.inspection_date}</p>
                                        <p>Insurance: ${response.schedule.insurance_date}</p>
                                        <p>Speed Governor: ${response.schedule.speed_governor_date}</p>
                                        <p>Kenha Permit: ${response.schedule.kenha_permit_date}</p>
                                        <button class="btn btn-info editScheduleBtn" data-toggle="modal" data-target="#editScheduleModal" data-id="${response.schedule.id}">Edit</button>
                                        <button class="btn btn-danger deleteScheduleBtn" data-id="${response.schedule.id}">Delete</button>
                                    </div>
                                </div>
                            </div>`;

                            $('#schedulesSection').append(newScheduleCard);
                            $('.vehicle-card[data-vehicle-id="' + vehicleId + '"]').remove();
                            $('#createScheduleModal').modal('hide');
                            $('#createScheduleForm')[0].reset();
                        } else {
                            alert("Failed to create schedule.");
                        }
                    },
                    error: function(xhr, status, error) {
                        alert("An error occurred while saving the schedule.");
                    }
                });
            });


            // Prepopulate schedule data in the edit schedule modal
            $('#editScheduleModal').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget);
                var scheduleId = button.data('id');
                $.ajax({
                    type: 'GET',
                    url: '{% url "get_schedule" id=0 %}'.replace('0', scheduleId),
                    success: function(response) {
                        var schedule = response.schedule;
                        var modal = $('#editScheduleModal');
                        modal.find('#editScheduleId').val(schedule.id);
                        modal.find('#editServiceProvider').val(schedule.service_provider);
                        modal.find('#editMaintenanceDate').val(schedule.maintenance_date);
                        modal.find('#editInspectionDate').val(schedule.inspection_date);
                        modal.find('#editInsuranceDate').val(schedule.insurance_date);
                        modal.find('#editSpeedGovernorDate').val(schedule.speed_governor_date);
                        modal.find('#editKenhaPermitDate').val(schedule.kenha_permit_date);
                    },
                    error: function(xhr, status, error) {
                        alert("An error occurred while fetching the schedule.");
                    }
                });
            });

            // Edit schedule form submit
          
            $.ajax({
                type: 'POST',
                url: '{% url "edit_schedule" pk=0 %}'.replace('0', scheduleId),
                data: $(this).serialize(),
                success: function(response) {
                    if (response.success) {
                        // Handle successful update
                    } else {
                        alert("Failed to update schedule.");
                    }
                },
                error: function(xhr, status, error) {
                    alert("An error occurred while updating the schedule.");
                }
            });
            // Edit schedule form submit
            $('#editScheduleForm').submit(function(e) {
                e.preventDefault();
                var scheduleId = $('#editScheduleId').val();
                $.ajax({
                    type: 'POST',
                    url: '{% url "edit_schedule" pk=0 %}'.replace('0', scheduleId),
                    data: $(this).serialize(),
                    success: function(response) {
                        if (response.success) {
                            var updatedSchedule = response.schedule;
                            var scheduleCard = $('.card[data-schedule-id="' + updatedSchedule.id + '"]');
                            scheduleCard.find('.card-title').text(updatedSchedule.vehicle_regno);
                            scheduleCard.find('p:contains("Maintenance:")').text('Maintenance: ' + updatedSchedule.maintenance_date);
                            scheduleCard.find('p:contains("Inspection:")').text('Inspection: ' + updatedSchedule.inspection_date);
                            scheduleCard.find('p:contains("Insurance:")').text('Insurance: ' + updatedSchedule.insurance_date);
                            scheduleCard.find('p:contains("Speed Governor:")').text('Speed Governor: ' + updatedSchedule.speed_governor_date);
                            scheduleCard.find('p:contains("Kenha Permit:")').text('Kenha Permit: ' + updatedSchedule.kenha_permit_date);
                            $('#editScheduleModal').modal('hide');
                        } else {
                            alert("Failed to update schedule.");
                        }
                    },
                    error: function(xhr, status, error) {
                        alert("An error occurred while updating the schedule.");
                    }
                });
            });

            

            // Show delete confirmation modal
            $('#schedulesSection').on('click', '.deleteScheduleBtn', function() {
                var scheduleId = $(this).data('id');
                $('#confirmDeleteBtn').data('id', scheduleId);
                $('#deleteConfirmationModal').modal('show');
            });

            // Confirm delete
            $('#confirmDeleteBtn').click(function() {
                var scheduleId = $(this).data('id');
                $.ajax({
                    type: 'POST',
                    url: '{% url "delete_schedule" id=0 %}'.replace('0', scheduleId),
                    data: {
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function(response) {
                        if (response.success) {
                            $('.card[data-schedule-id="' + scheduleId + '"]').remove();
                            $('#deleteConfirmationModal').modal('hide');
                        } else {
                            alert("Failed to delete schedule.");
                        }
                    },
                    error: function(xhr, status, error) {
                        alert("An error occurred while deleting the schedule.");
                    }
                });
            });
        });
    </script>
</body>
</html>
